<div class="perfil-wrapper" *ngIf="!cargando; else cargandoTemplate" (click)="ocultarOpcionesFuera($event)">
  <!-- ENCABEZADO -->
  <section class="perfil-header">
    <div class="perfil-info">
      <div class="perfil-avatar-container" (click)="toggleOpcionesFoto($event)">
        <img [src]="perfil" alt="Foto de perfil" class="perfil-avatar" />

        <div class="camera-icon">
          <i class="fa-solid fa-camera"></i>
        </div>

        <div class="opciones-foto" *ngIf="mostrarOpcionesFoto">
          <button (click)="fileInput.click()">Elegir foto de perfil</button>
          <button (click)="restaurarFoto()">Restaurar foto</button>
        </div>
      </div>

      <input type="file" #fileInput (change)="onFileSelected($event)" hidden />

      <div>
        <h2 class="nombre-usuario">{{ nombre }} {{ apellido }}</h2>
        <p>@{{ username }}</p>
        <span class="rol-badge" [ngStyle]="{ color: colorRol, 'background-color': fondoRol }">
          {{ rol }}
        </span>
      </div>
    </div>

    <div class="perfil-actions">
      <button class="btn-primary" (click)="editarPerfil()">Editar perfil</button>
      <button class="btn-outline" (click)="cerrarSesion()">Cerrar sesión</button>
    </div>
  </section>

  <!-- DATOS PERSONALES -->
  <section class="perfil-details">
    <h3 class="section-title">Datos personales</h3>
    <div class="detail-grid">
      <div class="detail-item">
        <label>Nombre completo</label>
        <p>{{ nombre }} {{ apellido }}</p>
      </div>
      <div class="detail-item">
        <label>Correo electrónico</label>
        <p>{{ email }}</p>
      </div>
      <div class="detail-item">
        <label>Celular</label>
        <p>{{ celular }}</p>
      </div>
      <div class="detail-item">
        <label>Rol</label>
        <p>{{ rol }}</p>
      </div>
      <div class="detail-item">
        <label>Estado</label>
        <p>{{ estado }}</p>
      </div>
      <div class="detail-item">
        <label>Fecha de registro</label>
        <p>{{ fechaRegistro }}</p>
      </div>
    </div>
  </section>

  <!-- RANKING -->
  <section class="perfil-ranking">
    <h3 class="section-title">Tu posición en el ranking</h3>
    <div class="ranking-container" *ngIf="posicion && totalUsuarios; else sinRanking">
      <div class="ranking-info">
        <p class="ranking-position">
          #{{ posicion }} <span>de {{ totalUsuarios }} usuarios</span>
        </p>
        <h4>{{ puntos }} puntos acumulados</h4>
        <div class="progress-bar">
          <div class="progress" [style.width.%]="progreso"></div>
        </div>
      </div>
      <div class="ranking-icon">
        <i class="fa-solid fa-trophy"></i>
      </div>
    </div>

    <ng-template #sinRanking>
      <p class="text-muted">Aún no tienes puntos acumulados en el ranking.</p>
    </ng-template>
  </section>

  <!-- HISTORIAL -->
  <section class="perfil-history">
    <h3 class="section-title">{{ tituloHistorial }}</h3>

    <!-- Vista alternativa para CIUDADANO y RECOLECTOR -->
    <ng-container *ngIf="rolRaw === 'CIUDADANO' || rolRaw === 'RECOLECTOR'; else vistaAutoridad">
      <div class="history-grid" *ngIf="ultimasEntregas.length > 0; else sinEntregas">
        <div class="history-card" *ngFor="let entrega of ultimasEntregas">
          <div class="history-header">
            <i class="fa-solid fa-recycle"></i>
            <span>{{ entrega.fechaEntrega | date:'dd/MM/yyyy' }}</span>
          </div>

          <p><strong>{{ entrega.material }}</strong> - {{ entrega.cantidad }} {{ entrega.unidad }}</p>
          <p class="points">+{{ entrega.puntosGanados }} pts</p>

          <small class="entrega-extra">
            <i class="fa-solid fa-location-dot"></i>
            {{ entrega.origenEntrega }}
          </small>
          <small class="entrega-extra">
            <i class="fa-solid fa-circle-info"></i>
            {{ entrega.estado || 'Sin estado' }}
          </small>
        </div>
      </div>

      <ng-template #sinEntregas>
        <div class="sin-entregas-card">
          <i class="fa-solid fa-box-open icono"></i>
          <h4>¡Aún no tienes entregas registradas!</h4>
          <p>
            Empieza a sumar puntos realizando tu primera entrega en un
            <strong>Punto Verde</strong> o participando en una
            <strong>Campaña Ambiental</strong>.
          </p>
          <div class="acciones">
            <button class="btn-blue" routerLink="../campanias">
              <i class="fa-solid fa-bullhorn"></i> Ver Campañas
            </button>
            <button class="btn-green" routerLink="../puntos-verdes">
              <i class="fa-solid fa-map-location-dot"></i> Ver Puntos Verdes
            </button>
          </div>
        </div>
      </ng-template>
    </ng-container>

    <!-- Vista alternativa para ADMIN y MUNICIPALIDAD -->
    <ng-template #vistaAutoridad>
      <div class="sin-entregas-card">
        <i class="fa-solid fa-city icono"></i>
        <h4>Panel de supervisión general</h4>
        <p>
          Como <strong>{{ rol }}</strong>, puedes acceder a tus herramientas de
          gestión y seguimiento de actividades ambientales.
        </p>
        <div class="acciones">
          <button class="btn-blue" routerLink="../incidencias">
            <i class="fa-solid fa-exclamation-triangle"></i> Incidencias
          </button>
          <button class="btn-green" routerLink="../reportes">
            <i class="fa-solid fa-chart-line"></i> Reportes
          </button>
        </div>
      </div>
    </ng-template>
  </section>

  <!-- TIP -->
  <div class="eco-tip">
    <i class="fa-solid fa-leaf"></i>
    <p>Recuerda depositar tus residuos en el contenedor correspondiente para contribuir al cuidado del medio ambiente.
    </p>
  </div>

  <!-- MODAL -->
  <div class="modal-overlay" *ngIf="mostrarEditor" (click)="cerrarModal($event)">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>Editar Perfil</h3>

      <label>Nombre</label>
      <input type="text" [(ngModel)]="formData.nombre" />

      <label>Apellido</label>
      <input type="text" [(ngModel)]="formData.apellido" />

      <label>Email</label>
      <input type="email" [(ngModel)]="formData.email" />

      <label>Celular</label>
      <input type="text" [(ngModel)]="formData.celular" />

      <div class="modal-actions">
        <button class="btn-primary" (click)="guardarCambios()">Guardar</button>
        <button class="btn-outline" (click)="mostrarEditor = false">
          Cancelar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- CARGANDO -->
<ng-template #cargandoTemplate>
  <div class="loading-container">
    <div class="spinner"></div>
    <p>Cargando perfil...</p>
  </div>
</ng-template>